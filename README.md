# README #

This repository contains the source for ECG simulator based on 3D voxel model of a human heart, analytic model of action potentials and cellular automaton for excitation sequence. It contains embedded optimization for determining AP model parameters from the prescribed ECG shape, the given heart model, and the given ECG measuring points (lead positions)

# Compiling the code

Run `make`-f makefile.manual    inside the ekgSim directory.
Note that Makefile was generated by CodeLite in Ubuntu environment and contains several absolute paths. These should in principle not matter when running make. If make fails, however, see if it is due to absolute paths or something being miss-configured in ekgSim.mk, simlib/simlib.mk

Make will create an executable in directory Release. This is an MPI-enabled parallel program but can be run sequentially if needed.

# Running the simulator

The simulator requires an environment to be set up. An example of such environment is given in directory testRun.
Before running the executable, adjust the parameters of simulator and optimization in *simulator.ini*.
Also set up the linked files (filenames are specified in simulator.ini).

## Sequential execution

~~~~
# parameters is a vector of numeric parameters (of the correct length, which is set in settings.ini), separated by commas (no spaces!)
Release/ekgSim test -sim parameters -out result
# the result of the simulation will be stored in result.column, which is in Matlab/octave readable text format
# result.column will contain _n+1_ columns, first is the time in milliseconds, followed by the _n_ simulated ECGs for all the measuring points
~~~~

Some of the results are also output to the standard output, for example:
~~~~
...
eval 1   simulation done in 439.131 seconds
 criteria = <0.099919,0.012262>, violation = 0
All done
~~~~

# Running the optimization
## Sequential mode

~~~~
# execute the simulator without extra parameters
Release/ekgSim
~~~~

Several files will be created as a result: 
- individuals.txt, which contains individuals that reside in the working population of the evolutionary optimization algorithm 
- evaluations.txt, which contains all the performed evaluations (even the ones that result in individuals with high (high = bad) value of objective functions)
- featureFile.txt, which contains the details of the execution (host name(s), execution time, etc)

## Parallel optimization

Parallel execution is supported on MPI enabled systems. Parallelization is done on the level of optimization only. This means that optimization will evaluate individuals (run individual simulations and evaluate their results under one or more criteria) in parallel on multiple machines or processes within the same machine. Apart from the execution command line, everything is the same as when running the program sequentially.

~~~~
# execute the simulator through MPI call on 16 processors:
mpirun -n 16 Release/ekgSim
~~~~
